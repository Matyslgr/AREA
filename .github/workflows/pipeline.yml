name: CI/CD Pipeline

on:
  push:
    branches: ['main', 'dev']
    tags: ['v*']
  pull_request:
    branches: ['main', 'dev']

jobs:
  build:
    name: ðŸ—ï¸ Build & Test
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: ðŸ§¹ Clean package-lock for optional deps
        run: rm -f package-lock.json

      - name: ðŸ“¦ Install Dependencies
        run: npm install

      - name: ðŸ—ï¸ Build Project
        run: npm run build

      - name: ðŸ§¹ Lint Check
        run: npm run lint --if-present

      - name: ðŸ§ª Run Tests
        run: npm test --if-present

      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: ðŸ“± Generate Android APK (Release)
        run: |
          cd apps/mobile
          npx expo prebuild --platform android

          echo "org.gradle.jvmargs=-Xmx4g -XX:MaxMetaspaceSize=2g" >> android/gradle.properties

          cd android
          chmod +x gradlew
          ./gradlew assembleRelease

      - name: ðŸš€ Prepare Release Assets
        run: |
          mkdir -p release-assets
          cp apps/mobile/android/app/build/outputs/apk/release/app-release.apk release-assets/client.apk

      - name: ðŸ“¤ Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          distribution: 'temurin'
          java-version: '17'

  mirror:
    name: ðŸªž Push to Epitech Mirror
    needs: [build]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    uses: Matyslgr/.github/.github/workflows/mirror.yml@main
    with:
      mirror_url: ${{ vars.MIRROR_URL }}
    secrets: inherit

  release:
    name: ðŸ“¦ Create GitHub Release
    needs: [build]
    if: |
      startsWith(github.ref, 'refs/tags/') ||
      (github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/dev' || github.ref == 'refs/heads/ci/apk_build'))

    permissions:
      contents: write

    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Download Artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-files
          path: dist

      - name: ðŸ“¦ Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ startsWith(github.ref, 'refs/tags/') && github.ref_name || 'latest' }}
          name: ${{ startsWith(github.ref, 'refs/tags/') && github.ref_name || 'Latest Development Build' }}
          body: |
            Automatic build from ${{ github.ref_name }} branch.
            Built on: ${{ github.event.head_commit.timestamp || 'N/A' }}
            Commit: ${{ github.sha }}
          files: dist/**/*
          generate_release_notes: true
          prerelease: false
          make_latest: true
